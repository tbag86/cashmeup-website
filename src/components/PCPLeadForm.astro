---
// PCP Claim lead form - Astro island
---

<div id="pcp-form-wrapper" class="w-full">
  <form id="pcp-form" class="space-y-5" novalidate>
    <!-- Success state -->
    <div id="pcp-success" class="hidden bg-[#E8F5E8] border border-[#2D6B2D]/30 rounded-xl p-6 text-center">
      <div class="w-14 h-14 bg-[#2D6B2D] rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h3 class="text-xl font-bold text-[#1B2A4A] mb-2">Application Received!</h3>
      <p class="text-slate-600 mb-4">Thank you â€” your PCP claim enquiry has been submitted. One of our regulated partners will be in touch within 24 hours to discuss your claim.</p>
      <p class="text-sm text-slate-500">Remember: this is completely free. You'll never be charged anything.</p>
    </div>

    <!-- Error state -->
    <div id="pcp-error" class="hidden bg-red-50 border border-red-200 rounded-xl p-4 text-red-700 text-sm"></div>

    <!-- Form fields -->
    <div id="pcp-fields">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="pcp-firstname" class="block text-sm font-semibold text-[#1B2A4A] mb-1.5">
            First Name <span class="text-red-500">*</span>
          </label>
          <input type="text" id="pcp-firstname" name="first_name" required autocomplete="given-name" placeholder="First name"
            class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#2D6B2D] focus:border-transparent" />
        </div>
        <div>
          <label for="pcp-lastname" class="block text-sm font-semibold text-[#1B2A4A] mb-1.5">
            Last Name <span class="text-red-500">*</span>
          </label>
          <input type="text" id="pcp-lastname" name="last_name" required autocomplete="family-name" placeholder="Last name"
            class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#2D6B2D] focus:border-transparent" />
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
        <div>
          <label for="pcp-email" class="block text-sm font-semibold text-[#1B2A4A] mb-1.5">
            Email Address <span class="text-red-500">*</span>
          </label>
          <input type="email" id="pcp-email" name="email" required autocomplete="email" placeholder="your@email.com"
            class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#2D6B2D] focus:border-transparent" />
        </div>
        <div>
          <label for="pcp-phone" class="block text-sm font-semibold text-[#1B2A4A] mb-1.5">
            Phone Number <span class="text-red-500">*</span>
          </label>
          <input type="tel" id="pcp-phone" name="phone" required autocomplete="tel" placeholder="07700 900000"
            class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#2D6B2D] focus:border-transparent" />
        </div>
      </div>

      <div class="mt-4">
        <fieldset>
          <legend class="block text-sm font-semibold text-[#1B2A4A] mb-2">
            Did you have car finance (PCP or HP) between 2007 and 2021? <span class="text-red-500">*</span>
          </legend>
          <div class="flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="had_car_finance" value="yes" required
                class="w-4 h-4 text-[#2D6B2D] focus:ring-[#2D6B2D]" />
              <span class="text-sm font-medium text-slate-700">Yes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="had_car_finance" value="no"
                class="w-4 h-4 text-[#2D6B2D] focus:ring-[#2D6B2D]" />
              <span class="text-sm font-medium text-slate-700">No</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="had_car_finance" value="not-sure"
                class="w-4 h-4 text-[#2D6B2D] focus:ring-[#2D6B2D]" />
              <span class="text-sm font-medium text-slate-700">Not sure</span>
            </label>
          </div>
        </fieldset>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
        <div>
          <label for="pcp-start-year" class="block text-sm font-semibold text-[#1B2A4A] mb-1.5">
            Approximate Finance Start Year
          </label>
          <select id="pcp-start-year" name="finance_start_year"
            class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#2D6B2D] focus:border-transparent bg-white">
            <option value="">Select year</option>
            {Array.from({ length: 15 }, (_, i) => 2007 + i).map(year => (
              <option value={year}>{year}</option>
            ))}
          </select>
        </div>
        <div>
          <label for="pcp-lender" class="block text-sm font-semibold text-[#1B2A4A] mb-1.5">
            Finance Provider / Lender <span class="text-slate-400 font-normal">(if known)</span>
          </label>
          <input type="text" id="pcp-lender" name="lender" placeholder="e.g. Black Horse, Santander"
            class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#2D6B2D] focus:border-transparent" />
        </div>
      </div>

      <div class="mt-5 p-4 bg-[#F5F7FA] rounded-xl">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" name="consent" id="pcp-consent" required
            class="mt-0.5 w-4 h-4 rounded border-slate-300 text-[#2D6B2D] focus:ring-[#2D6B2D] flex-shrink-0" />
          <span class="text-xs text-slate-600 leading-relaxed">
            <strong class="text-[#1B2A4A]">I give my consent</strong> for Cash Me Up to pass my details to a regulated claims management company to assess my PCP claim. I understand this service is completely free to me, and I won't be charged anything. I've read and agree to the <a href="/privacy-policy/" class="text-[#2D6B2D] hover:underline">Privacy Policy</a> and <a href="/terms/" class="text-[#2D6B2D] hover:underline">Terms of Service</a>. <span class="text-red-500">*</span>
          </span>
        </label>
      </div>

      <button type="submit" id="pcp-submit" class="w-full btn-primary mt-5 py-4 text-base">
        <span id="pcp-btn-text">
          <svg class="w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Start My Free PCP Claim Check
        </span>
        <span id="pcp-btn-loading" class="hidden items-center justify-center gap-2">
          <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Submitting...
        </span>
      </button>

      <p class="text-center text-xs text-slate-400 mt-3">
        ðŸ”’ Your data is encrypted and secure. We never sell your information.
      </p>
    </div>
  </form>
</div>

<script>
  const form = document.getElementById('pcp-form') as HTMLFormElement;
  const successEl = document.getElementById('pcp-success');
  const errorEl = document.getElementById('pcp-error');
  const fieldsEl = document.getElementById('pcp-fields');
  const btnText = document.getElementById('pcp-btn-text');
  const btnLoading = document.getElementById('pcp-btn-loading');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorEl?.classList.add('hidden');

    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    btnLoading?.classList.add('flex');

    const formData = new FormData(form);
    const data = {
      first_name: formData.get('first_name'),
      last_name: formData.get('last_name'),
      email: formData.get('email'),
      phone: formData.get('phone'),
      had_car_finance: formData.get('had_car_finance'),
      finance_start_year: formData.get('finance_start_year') || '',
      lender: formData.get('lender') || '',
      consent: formData.get('consent') === 'on' ? 1 : 0,
    };

    try {
      const res = await fetch('/api/pcp-lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      const result = await res.json();

      if (result.success) {
        fieldsEl?.classList.add('hidden');
        successEl?.classList.remove('hidden');
        successEl?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        if (errorEl) {
          errorEl.textContent = result.error || 'Something went wrong. Please try again.';
          errorEl.classList.remove('hidden');
        }
        btnText?.classList.remove('hidden');
        btnLoading?.classList.add('hidden');
        btnLoading?.classList.remove('flex');
      }
    } catch {
      if (errorEl) {
        errorEl.textContent = 'Network error. Please check your connection and try again.';
        errorEl.classList.remove('hidden');
      }
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
      btnLoading?.classList.remove('flex');
    }
  });
</script>
